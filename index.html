<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>MediScript AI - Firebase Edition</title>
  <script src="https://cdn.tailwindcss.com"></script>
  
  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
  
  <!-- jsPDF for PDF generation -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; background: #f8f9fa; }
    .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 9999; align-items: center; justify-content: center; overflow-y: auto; }
    .modal.active { display: flex; }
    .toast { position: fixed; top: 80px; right: 20px; background: white; padding: 16px 20px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); z-index: 10000; display: none; align-items: center; gap: 12px; min-width: 300px; }
    .toast.show { display: flex; animation: slideIn 0.3s; }
    @keyframes slideIn { from { transform: translateX(400px); } to { transform: translateX(0); } }
    .spinner { border: 3px solid #f3f3f3; border-top: 3px solid #3b82f6; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 0 auto; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    .auth-container { min-height: 100vh; display: flex; align-items: center; justify-content: center; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
    .auth-card { background: white; padding: 40px; border-radius: 16px; box-shadow: 0 20px 60px rgba(0,0,0,0.3); max-width: 400px; width: 90%; }
  </style>
</head>
<body>
  <div id="app">
    <div class="auth-container">
      <div class="auth-card">
        <div class="text-center mb-8">
          <h1 class="text-3xl font-bold text-gray-800 mb-2">ü§ñ MediScript AI</h1>
          <p class="text-gray-600">Firebase Edition - Cloud-Powered</p>
        </div>
        <div class="spinner"></div>
        <p class="text-center text-gray-600 mt-4">Initializing Firebase...</p>
      </div>
    </div>
  </div>
  
  <div class="toast" id="toast">
    <span id="toastIcon"></span>
    <span id="toastMessage"></span>
  </div>

  <!-- Configuration -->
  <script src="config.js"></script>
  <script src="firebase-config.js"></script>
  <script src="auth.js"></script>
  <script src="database.js"></script>
  <script src="drug-database.js"></script>
  <script src="billing.js"></script>
  <script src="utils.js"></script>
  
  <script>
    // Initialize Firebase and check authentication
    document.addEventListener('DOMContentLoaded', async () => {
      const initialized = initializeFirebase();
      
      if (!initialized) {
        document.getElementById('app').innerHTML = `
          <div class="auth-container">
            <div class="auth-card">
              <div class="text-center">
                <h1 class="text-2xl font-bold text-red-600 mb-4">‚ùå Firebase Error</h1>
                <p class="text-gray-600 mb-4">Failed to initialize Firebase. Please check your configuration.</p>
                <button onclick="location.reload()" class="bg-blue-500 text-white px-6 py-2 rounded-lg hover:bg-blue-600">
                  Retry
                </button>
              </div>
            </div>
          </div>
        `;
        return;
      }

      // Check authentication state
      onAuthStateChanged((user) => {
        if (user) {
          // User is signed in
          console.log('‚úÖ User authenticated:', user.email);
          loadMainApp(user);
        } else {
          // User is signed out
          console.log('‚ùå User not authenticated');
          showLoginPage();
        }
      });
    });

    // Show login page
    function showLoginPage() {
      document.getElementById('app').innerHTML = `
        <div class="auth-container">
          <div class="auth-card">
            <div class="text-center mb-8">
              <h1 class="text-3xl font-bold text-gray-800 mb-2">ü§ñ MediScript AI</h1>
              <p class="text-gray-600">Sign in to continue</p>
            </div>

            <div id="authTabs" class="flex gap-2 mb-6">
              <button onclick="switchTab('login')" id="loginTab" class="flex-1 py-2 px-4 rounded-lg bg-blue-500 text-white font-medium">
                Login
              </button>
              <button onclick="switchTab('register')" id="registerTab" class="flex-1 py-2 px-4 rounded-lg bg-gray-200 text-gray-700 font-medium">
                Register
              </button>
            </div>

            <div id="loginForm">
              <input type="email" id="loginEmail" placeholder="Email" class="w-full px-4 py-3 border border-gray-300 rounded-lg mb-3 focus:outline-none focus:ring-2 focus:ring-blue-500">
              <input type="password" id="loginPassword" placeholder="Password" class="w-full px-4 py-3 border border-gray-300 rounded-lg mb-4 focus:outline-none focus:ring-2 focus:ring-blue-500">
              <button onclick="handleLogin()" class="w-full bg-blue-500 text-white py-3 rounded-lg font-medium hover:bg-blue-600 mb-3">
                Sign In
              </button>
              <button onclick="handleGoogleSignIn()" class="w-full bg-white border border-gray-300 text-gray-700 py-3 rounded-lg font-medium hover:bg-gray-50 flex items-center justify-center gap-2">
                <svg class="w-5 h-5" viewBox="0 0 24 24"><path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/><path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/><path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/><path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/></svg>
                Sign in with Google
              </button>
            </div>

            <div id="registerForm" style="display: none;">
              <input type="text" id="registerName" placeholder="Full Name" class="w-full px-4 py-3 border border-gray-300 rounded-lg mb-3 focus:outline-none focus:ring-2 focus:ring-blue-500">
              <input type="email" id="registerEmail" placeholder="Email" class="w-full px-4 py-3 border border-gray-300 rounded-lg mb-3 focus:outline-none focus:ring-2 focus:ring-blue-500">
              <input type="password" id="registerPassword" placeholder="Password (min 6 characters)" class="w-full px-4 py-3 border border-gray-300 rounded-lg mb-4 focus:outline-none focus:ring-2 focus:ring-blue-500">
              <button onclick="handleRegister()" class="w-full bg-blue-500 text-white py-3 rounded-lg font-medium hover:bg-blue-600">
                Create Account
              </button>
            </div>
          </div>
        </div>
      `;
    }

    // Switch between login and register tabs
    function switchTab(tab) {
      const loginTab = document.getElementById('loginTab');
      const registerTab = document.getElementById('registerTab');
      const loginForm = document.getElementById('loginForm');
      const registerForm = document.getElementById('registerForm');

      if (tab === 'login') {
        loginTab.className = 'flex-1 py-2 px-4 rounded-lg bg-blue-500 text-white font-medium';
        registerTab.className = 'flex-1 py-2 px-4 rounded-lg bg-gray-200 text-gray-700 font-medium';
        loginForm.style.display = 'block';
        registerForm.style.display = 'none';
      } else {
        loginTab.className = 'flex-1 py-2 px-4 rounded-lg bg-gray-200 text-gray-700 font-medium';
        registerTab.className = 'flex-1 py-2 px-4 rounded-lg bg-blue-500 text-white font-medium';
        loginForm.style.display = 'none';
        registerForm.style.display = 'block';
      }
    }

    // Handle login
    async function handleLogin() {
      const email = document.getElementById('loginEmail').value;
      const password = document.getElementById('loginPassword').value;

      if (!email || !password) {
        showToast('Please enter email and password', 'error');
        return;
      }

      const result = await signIn(email, password);
      if (result.success) {
        showToast('Login successful!', 'success');
      } else {
        showToast(result.error, 'error');
      }
    }

    // Handle registration
    async function handleRegister() {
      const name = document.getElementById('registerName').value;
      const email = document.getElementById('registerEmail').value;
      const password = document.getElementById('registerPassword').value;

      if (!name || !email || !password) {
        showToast('Please fill all fields', 'error');
        return;
      }

      if (password.length < 6) {
        showToast('Password must be at least 6 characters', 'error');
        return;
      }

      const result = await signUp(email, password, name);
      if (result.success) {
        showToast('Account created successfully!', 'success');
      } else {
        showToast(result.error, 'error');
      }
    }

    // Handle Google Sign-In
    async function handleGoogleSignIn() {
      const result = await signInWithGoogle();
      if (result.success) {
        showToast('Google sign-in successful!', 'success');
      } else {
        showToast(result.error, 'error');
      }
    }

    // Load main application
    function loadMainApp(user) {
      document.getElementById('app').innerHTML = `
        <div class="min-h-screen bg-gray-50">
          <!-- Header -->
          <header class="bg-white shadow-sm border-b border-gray-200">
            <div class="max-w-7xl mx-auto px-4 py-4 flex items-center justify-between">
              <div class="flex items-center gap-3">
                <div class="text-3xl">ü§ñ</div>
                <div>
                  <h1 class="text-xl font-bold text-gray-800">MediScript AI</h1>
                  <p class="text-sm text-gray-500">Firebase Edition</p>
                </div>
              </div>
              <div class="flex items-center gap-4">
                <div class="text-right">
                  <p class="text-sm font-medium text-gray-800">${user.displayName || user.email}</p>
                  <p class="text-xs text-gray-500">Doctor</p>
                </div>
                <button onclick="handleSignOut()" class="bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600 text-sm font-medium">
                  Sign Out
                </button>
              </div>
            </div>
          </header>

          <!-- Main Content -->
          <main class="max-w-7xl mx-auto px-4 py-8">
            <div class="bg-white rounded-lg shadow-sm p-8 text-center">
              <h2 class="text-2xl font-bold text-gray-800 mb-4">üéâ Welcome to MediScript AI Firebase Edition!</h2>
              <p class="text-gray-600 mb-6">You're successfully authenticated with Firebase!</p>
              
              <div class="grid grid-cols-1 md:grid-cols-3 gap-6 max-w-4xl mx-auto">
                <div class="bg-blue-50 p-6 rounded-lg">
                  <div class="text-4xl mb-3">‚úÖ</div>
                  <h3 class="font-bold text-gray-800 mb-2">Firebase Auth</h3>
                  <p class="text-sm text-gray-600">Email & Google Sign-In Working</p>
                </div>
                <div class="bg-green-50 p-6 rounded-lg">
                  <div class="text-4xl mb-3">üî•</div>
                  <h3 class="font-bold text-gray-800 mb-2">Firestore Database</h3>
                  <p class="text-sm text-gray-600">Cloud Storage Ready</p>
                </div>
                <div class="bg-purple-50 p-6 rounded-lg">
                  <div class="text-4xl mb-3">ü§ñ</div>
                  <h3 class="font-bold text-gray-800 mb-2">AI Prescriptions</h3>
                  <p class="text-sm text-gray-600">Groq Llama 3.3 70B Active</p>
                </div>
              </div>

              <div class="mt-8 p-6 bg-yellow-50 rounded-lg">
                <p class="text-sm text-gray-700">
                  <strong>üöß Under Development:</strong> Full patient management, appointments, and AI prescription features are being integrated with Firebase. 
                  This is the authentication-enabled version. The complete app will be ready soon!
                </p>
              </div>
            </div>
          </main>
        </div>
      `;
    }

    // Handle sign out
    async function handleSignOut() {
      const result = await signOut();
      if (result) {
        showToast('Signed out successfully', 'success');
        showLoginPage();
      }
    }

    // Toast notification
    function showToast(message, type = 'info') {
      const toast = document.getElementById('toast');
      const icon = document.getElementById('toastIcon');
      const msg = document.getElementById('toastMessage');

      const icons = {
        success: '‚úÖ',
        error: '‚ùå',
        info: '‚ÑπÔ∏è',
        warning: '‚ö†Ô∏è'
      };

      icon.textContent = icons[type] || icons.info;
      msg.textContent = message;
      toast.className = 'toast show';

      setTimeout(() => {
        toast.className = 'toast';
      }, 3000);
    }
  </script>
</body>
</html>
